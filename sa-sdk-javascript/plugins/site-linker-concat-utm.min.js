sensorsDataAnalytic201505.modules.SiteLinkerConcatUtm = (function () {
  'use strict'
  var t = {}
  ;(t.getPart = function (t) {
    var i = !1,
      e = this.option.length
    if (e) for (var r = 0; r < e; r++) if (t.indexOf(this.option[r].part_url) > -1) return !0
    return i
  }),
    (t.getPartHash = function (t) {
      var i = this.option.length,
        e = !1
      if (i)
        for (var r = 0; r < i; r++)
          if (t.indexOf(this.option[r].part_url) > -1) return this.option[r].after_hash
      return !!e
    }),
    (t.getCurrenId = function () {
      var t = this.store.getDistinctId() || '',
        i = this.store.getFirstId() || ''
      this._.urlSafeBase64 && this._.urlSafeBase64.encode
        ? (t = t
            ? this._.urlSafeBase64.trim(this._.urlSafeBase64.encode(this._.base64Encode(t)))
            : '')
        : this._.rot13obfs && (t = t ? this._.rot13obfs(t) : '')
      var e = i ? 'f' + t : 'd' + t
      return encodeURIComponent(e)
    }),
    (t.rewriteUrl = function (t, i) {
      var e = /([^?#]+)(\?[^#]*)?(#.*)?/,
        r = e.exec(t),
        s = ''
      if (r) {
        var n,
          a = r[1] || '',
          o = r[2] || '',
          u = r[3] || ''
        if (this.getPartHash(t)) {
          n = u.indexOf('_sasdk')
          var h = u.indexOf('?')
          s =
            h > -1
              ? n > -1
                ? a + o + '#' + u.substring(1, n) + '_sasdk=' + this.getCurrenId()
                : a + o + '#' + u.substring(1) + '&_sasdk=' + this.getCurrenId()
              : a + o + '#' + u.substring(1) + '?_sasdk=' + this.getCurrenId()
        } else {
          n = o.indexOf('_sasdk')
          var d = /^\?(\w)+/.test(o)
          s = d
            ? n > -1
              ? a + '?' + o.substring(1, n) + '_sasdk=' + this.getCurrenId() + u
              : a + '?' + o.substring(1) + '&_sasdk=' + this.getCurrenId() + u
            : a + '?' + o.substring(1) + '_sasdk=' + this.getCurrenId() + u
        }
        return i && (i.href = s), s
      }
    }),
    (t.getUrlId = function () {
      var t = location.href.match(/_sasdk=([aufd][^\?\#\&\=]+)/)
      if (this._.isArray(t) && t[1]) {
        var i = decodeURIComponent(t[1])
        return (
          !i ||
            ('f' !== i.substring(0, 1) && 'd' !== i.substring(0, 1)) ||
            (this._.urlSafeBase64 &&
            this._.urlSafeBase64.isUrlSafeBase64 &&
            this._.urlSafeBase64.isUrlSafeBase64(i)
              ? (i =
                  i.substring(0, 1) +
                  this._.base64Decode(this._.urlSafeBase64.decode(i.substring(1))))
              : this._.rot13defs && (i = i.substring(0, 1) + this._.rot13defs(i.substring(1)))),
          i
        )
      }
      return ''
    }),
    (t.setRefferId = function () {
      var t = this.store.getDistinctId(),
        i = this.getUrlId()
      if ('' === i) return !1
      var e = 'a' === i.substring(0, 1) || 'd' === i.substring(0, 1)
      return (
        (i = i.substring(1)),
        i !== t &&
          (i &&
            e &&
            this.store.getFirstId() &&
            (this.sd.identify(i, !0),
            this.sd.saEvent.send(
              {
                original_id: i,
                distinct_id: t,
                type: 'track_signup',
                event: '$SignUp',
                properties: {}
              },
              null
            )),
          i && e && !this.store.getFirstId() && this.sd.identify(i, !0),
          void (!i || e || this.store.getFirstId() || this.sd.login(i)))
      )
    }),
    (t.addListen = function () {
      var t = this,
        i = function (i) {
          var e,
            r,
            s = i.target,
            n = s.tagName.toLowerCase(),
            a = s.parentNode
          if (
            ('a' === n && s.href) ||
            (a && a.tagName && 'a' === a.tagName.toLowerCase() && a.href)
          ) {
            'a' === n && s.href ? ((e = s.href), (r = s)) : ((e = a.href), (r = a))
            var o = t._.URL(e),
              u = o.protocol
            ;('http:' !== u && 'https:' !== u) || (t.getPart(e) && t.rewriteUrl(e, r))
          }
        }
      t._.addEvent(document, 'mousedown', i),
        window.PointerEvent &&
          'maxTouchPoints' in window.navigator &&
          window.navigator.maxTouchPoints >= 0 &&
          t._.addEvent(document, 'pointerdown', i)
    }),
    (t.init = function (t, i) {
      function e(i) {
        for (var e = i.length, r = [], s = 0; s < e; s++)
          /[A-Za-z0-9]+\./.test(i[s].part_url) &&
          '[object Boolean]' == Object.prototype.toString.call(i[s].after_hash)
            ? r.push(i[s])
            : t.log('linker 配置的第 ' + (s + 1) + ' 项格式不正确，请检查参数格式！')
        return r
      }
      return (
        (this.sd = t),
        (this._ = t._),
        (this.store = t.store),
        (this.para = t.para),
        this._.isObject(i) && this._.isArray(i.linker) && i.linker.length > 0
          ? (this.setRefferId(),
            this.addListen(),
            (this.option = i.linker),
            void (this.option = e(this.option)))
          : void t.log('请配置打通域名参数！')
      )
    })
  var i = t,
    e = t.rewriteUrl
  return (
    (i.rewriteUrl = function (t, i) {
      function r(t) {
        var i = {}
        if (a._.isArray(t)) {
          var e = t[2] || ''
          if ('' !== e)
            for (var r = e.slice(1).split('&'), s = 0; s < r.length; s++) {
              var n = r[s].split('=')
              i[n[0]] = n[1]
            }
        }
        return i
      }
      function s(t) {
        var i = {}
        if (a._.isArray(t)) {
          var e = t[3] || ''
          if ('' !== e) {
            var r = e.split('?')
            if (r[1])
              for (var s = r[1].split('&'), n = 0; n < s.length; n++) {
                var o = s[n].split('=')
                i[o[0]] = o[1]
              }
          }
        }
        return i
      }
      function n(t) {
        for (var i = t.length; i--; ) {
          var e = t.shift(),
            r = e.split('=')[0]
          l.indexOf(r) == -1 && t.push(e)
        }
        return t
      }
      var a = this,
        o = e.call(this, t, i),
        u = /([^?#]+)(\?[^#]*)?(#.*)?/,
        h = u.exec(location.href),
        d = r(h),
        f = s(h),
        l = [
          'utm_source',
          'utm_medium',
          'utm_campaign',
          'utm_content',
          'utm_term',
          '_channel_track_key'
        ],
        c = {}
      this._.each(l, function (t) {
        t in d && (c[t] = d[t]), t in f && !(t in c) && (c[t] = f[t])
      })
      var g = ''
      if (!this._.isEmptyObject(c)) {
        var _ = ''
        for (var v in c) _ += '&' + v + '=' + c[v]
        var p = u.exec(o),
          S = p[1] || '',
          b = p[2] || '',
          m = p[3] || ''
        g += S
        var w = []
        '' !== b && ((w = n(b.slice(1).split('&'))), w.length && (g += '?' + w.join('&')))
        var k = [],
          I = '',
          D = ''
        if ('' !== m) {
          var U = m.split('?')
          ;(I = U[0] || ''), (D = U[1] || ''), (g += I)
        }
        '' !== D && ((k = n(D.split('&'))), k.length && (g += '?' + k.join('&')))
        var C = g.indexOf('_sasdk=')
        o = g.slice(0, C) + _.slice(1) + '&' + g.slice(C)
      }
      return i && (i.href = o), o
    }),
    window.SensorsDataWebJSSDKPlugin &&
    '[object Object]' === Object.prototype.toString.call(window.SensorsDataWebJSSDKPlugin)
      ? ((window.SensorsDataWebJSSDKPlugin.SiteLinkerConcatUtm =
          window.SensorsDataWebJSSDKPlugin.SiteLinkerConcatUtm || i),
        (window.SensorsDataWebJSSDKPlugin.SiteLinker = { init: function () {} }))
      : (window.SensorsDataWebJSSDKPlugin = {
          SiteLinkerConcatUtm: i,
          SiteLinker: { init: function () {} }
        }),
    i
  )
})()
